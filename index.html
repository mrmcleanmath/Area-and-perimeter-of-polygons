<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Area and Perimeter of Polygons – Mr. McLean Math</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg: #f5f5f5;
      --fg: #222;
      --accent: #2b7cff;
      --accent-soft: #e2ecff;
      --error: #c62828;
      --success: #2e7d32;
      --panel: #ffffff;
    }
    body.high-contrast {
      --bg: #000;
      --fg: #fff;
      --accent: #ff9800;
      --accent-soft: #333;
      --panel: #111;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--fg);
    }

    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin-bottom: 12px;
      font-size: 1.8rem;
    }

    .top-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
      margin-bottom: 12px;
    }

    .control-group {
      background: var(--panel);
      border-radius: 8px;
      padding: 6px 10px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.9rem;
    }

    select, input[type="checkbox"] {
      font-size: 0.9rem;
    }

    .modes-bar {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin: 8px 0 16px;
    }

    .tab-btn {
      padding: 6px 14px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      background: #ddd;
      font-weight: 600;
    }
    .tab-btn.active {
      background: var(--accent);
      color: #fff;
    }

    .main-layout {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
    }

    #diagramContainer {
      flex: 1 1 320px;
      min-width: 280px;
      background: var(--panel);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }

    #diagramContainer svg {
      width: 100%;
      height: auto;
      max-height: 320px;
      display: block;
    }

    #questionPanel {
      flex: 1 1 320px;
      min-width: 280px;
      background: var(--panel);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #promptText {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
    }

    #answerInput {
      font-size: 1.2rem;
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid #aaa;
      width: 100%;
    }

    .buttons-row {
      display: flex;
      gap: 8px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    button {
      font-size: 1rem;
      padding: 6px 14px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
    }

    #submitBtn {
      background: var(--accent);
      color: #fff;
    }
    #nextBtn {
      background: #bbb;
      color: #000;
    }
    #nextBtn.enabled {
      background: #4caf50;
      color: #fff;
    }

    #feedbackPanel {
      margin-top: 6px;
      min-height: 40px;
      font-size: 0.95rem;
      border-radius: 8px;
      padding: 6px 8px;
      background: var(--accent-soft);
    }

    #feedbackText.success {
      color: var(--success);
      font-weight: 600;
    }

    #feedbackText.error {
      color: var(--error);
      font-weight: 600;
    }

    #showStepsBtn {
      background: transparent;
      color: var(--accent);
      padding: 0;
      border-radius: 0;
      text-decoration: underline;
      font-size: 0.9rem;
    }

    #stepsText {
      font-size: 0.85rem;
      margin-top: 4px;
      white-space: pre-wrap;
    }

    #scorePanel {
      margin-top: 12px;
      background: var(--panel);
      border-radius: 10px;
      padding: 8px 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      justify-content: space-between;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
      font-size: 0.9rem;
    }

    #timerDisplay {
      font-weight: 700;
    }

    #summaryPanel {
      margin-top: 10px;
      background: var(--panel);
      border-radius: 10px;
      padding: 10px;
      display: none;
      font-size: 0.9rem;
      max-height: 340px;
      overflow-y: auto;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
    }

    .incorrect-item {
      margin-bottom: 8px;
      padding-bottom: 6px;
      border-bottom: 1px solid #ddd;
    }

    .incorrect-item:last-child {
      border-bottom: none;
    }

    #worksheetMode {
      display: none;
      background: var(--panel);
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.12);
      margin-top: 8px;
    }

    .worksheet-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
      align-items: center;
    }

    .worksheet-header {
      font-weight: 600;
      margin-bottom: 8px;
      text-align: center;
      font-size: 1.1rem;
    }

    .worksheet-question {
      border-bottom: 1px solid #ccc;
      padding: 12px 0;
      margin-bottom: 6px;
    }

    .worksheet-line {
      height: 28px;
      border-bottom: 1px solid #555;
      margin-top: 6px;
      margin-right: 10%;
    }

    .worksheet-answer {
      display: none;
      font-size: 0.9rem;
      margin-top: 4px;
    }

    .worksheet-diagram {
      max-width: 260px;
      margin-bottom: 4px;
    }

    .footer {
      text-align: center;
      font-size: 0.85rem;
      margin: 16px 0 8px;
      color: #666;
    }

    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      background: #eee;
      font-size: 0.75rem;
      margin-right: 4px;
    }

    #devPanel {
      margin-top: 12px;
      padding: 8px;
      border-radius: 8px;
      background: #212121;
      color: #e0e0e0;
      font-family: "SF Mono", Menlo, Consolas, monospace;
      font-size: 0.8rem;
      display: none;
      white-space: pre-wrap;
    }

    @media (max-width: 720px) {
      #diagramContainer svg {
        max-height: 260px;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <h1>Area and Perimeter of Polygons</h1>

  <div class="top-controls">
    <div class="control-group">
      <label for="shapeSetSelect"><strong>Shapes:</strong></label>
      <select id="shapeSetSelect">
        <option value="both">Quadrilaterals &amp; Triangles</option>
        <option value="quadrilaterals">Quadrilaterals only</option>
        <option value="triangles">Triangles only</option>
      </select>
    </div>
    <div class="control-group">
      <label for="skillSelect"><strong>Skill:</strong></label>
      <select id="skillSelect">
        <option value="perimeter">Perimeter</option>
        <option value="area">Area</option>
        <option value="mixed">Mixed</option>
      </select>
    </div>
    <div class="control-group">
      <label><input type="checkbox" id="timerToggle"> Timer</label>
      <select id="timerDuration">
        <option value="30">30 s</option>
        <option value="60" selected>60 s</option>
        <option value="90">90 s</option>
        <option value="120">120 s</option>
      </select>
      <span id="timerDisplay"></span>
    </div>
    <div class="control-group">
      <label><input type="checkbox" id="soundToggle" checked> Sound</label>
    </div>
    <div class="control-group">
      <label><input type="checkbox" id="contrastToggle"> High contrast</label>
    </div>
  </div>

  <div class="modes-bar">
    <button class="tab-btn active" id="gameTab">Game mode</button>
    <button class="tab-btn" id="worksheetTab">Worksheet mode</button>
  </div>

  <div id="gameMode">
    <div class="main-layout">
      <div id="diagramContainer" aria-label="Polygon diagram">
        <!-- SVG inserted here -->
      </div>
      <div id="questionPanel">
        <div id="promptText">Loading question…</div>
        <input id="answerInput" type="text" autocomplete="off" aria-label="Your answer">
        <div class="buttons-row">
          <button id="submitBtn">Submit</button>
          <button id="nextBtn" disabled>Next</button>
          <button id="summaryBtn" type="button">Summary</button>
        </div>
        <div id="feedbackPanel" aria-live="polite">
          <div id="feedbackText"></div>
          <button id="showStepsBtn" style="display:none;">Show steps</button>
          <div id="stepsText"></div>
        </div>
      </div>
    </div>

    <div id="scorePanel">
      <div><span class="badge">Score</span><span id="scoreValue">0</span></div>
      <div><span class="badge">Streak</span><span id="streakValue">0</span> (Best: <span id="bestStreakValue">0</span>)</div>
      <div><span class="badge">Attempts</span><span id="attemptsValue">0</span></div>
      <div><span class="badge">Correct</span><span id="correctValue">0</span></div>
      <div><span class="badge">Accuracy</span><span id="accuracyValue">0%</span></div>
    </div>

    <div id="summaryPanel">
      <strong>Session summary</strong>
      <div id="summaryText" style="margin:6px 0;"></div>
      <details>
        <summary>Incorrect questions</summary>
        <div id="incorrectList"></div>
      </details>
    </div>
  </div>

  <div id="worksheetMode">
    <div class="worksheet-header">Area and Perimeter of Polygons – Worksheet</div>
    <div class="worksheet-controls">
      <span>Create:</span>
      <button class="ws-generate-btn" data-count="5">5 questions</button>
      <button class="ws-generate-btn" data-count="10">10 questions</button>
      <button class="ws-generate-btn" data-count="15">15 questions</button>
      <button id="wsRevealBtn">Reveal answers</button>
      <button id="wsHideBtn">Hide answers</button>
    </div>
    <div id="worksheetContainer"></div>
  </div>

  <div id="devPanel"></div>

  <div class="footer">
    Created by Mr. McLean Math.
  </div>
</div>

<script>
(function() {
  // ---------- Utility functions ----------
  function randInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
  }

  function randLength() {
    // 70% integer, 30% one decimal
    if (Math.random() < 0.7) {
      return randInt(2, 30);
    } else {
      const n = randInt(20, 300); // 2.0 - 30.0
      return n / 10;
    }
  }

  function toNumber(value) {
    if (typeof value === "number") return value;
    const str = String(value).replace(/\s+/g, "").replace(",", ".");
    const n = parseFloat(str);
    return isNaN(n) ? null : n;
  }

  function roundTo(n, decimals) {
    const factor = Math.pow(10, decimals);
    return Math.round(n * factor) / factor;
  }

  function formatNumber(n) {
    const neg = n < 0;
    n = Math.abs(n);
    n = roundTo(n, 2); // display up to 2 decimals
    let str = n.toString();
    const parts = str.split(".");
    let intPart = parts[0];
    const decPart = parts.length > 1 ? parts[1] : "";
    const rgx = /(\d+)(\d{3})/;
    while (rgx.test(intPart)) {
      intPart = intPart.replace(rgx, "$1" + " " + "$2");
    }
    const joined = decPart ? intPart + "." + decPart : intPart;
    return neg ? "-" + joined : joined;
  }

  function approxEqual(a, b, tol) {
    return Math.abs(a - b) <= tol;
  }

  // ---------- Sound ----------
  let audioCtx = null;
  function beep(type) {
    if (!document.getElementById("soundToggle").checked) return;
    if (!window.AudioContext && !window.webkitAudioContext) return;
    if (!audioCtx) {
      const Ctx = window.AudioContext || window.webkitAudioContext;
      audioCtx = new Ctx();
    }
    const duration = type === "correct" ? 0.12 : 0.22;
    const freq = type === "correct" ? 880 : 220;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = "sine";
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(audioCtx.destination);
    const now = audioCtx.currentTime;
    gain.gain.setValueAtTime(0.0001, now);
    gain.gain.exponentialRampToValueAtTime(0.3, now + 0.01);
    gain.gain.exponentialRampToValueAtTime(0.0001, now + duration);
    osc.start(now);
    osc.stop(now + duration + 0.02);
  }

  // ---------- Problem generation ----------
  function chooseSkill() {
    const skillSel = document.getElementById("skillSelect").value;
    if (skillSel === "mixed") {
      return Math.random() < 0.5 ? "area" : "perimeter";
    }
    return skillSel;
  }

  function chooseShapeType() {
    const set = document.getElementById("shapeSetSelect").value;
    const quads = ["square", "rectangle", "parallelogram", "rhombus"];
    const tris  = ["rightTriangle", "isoscelesTriangle", "equilateralTriangle", "scaleneTriangle"];
    let list;
    if (set === "quadrilaterals") list = quads;
    else if (set === "triangles") list = tris;
    else list = quads.concat(tris);
    const idx = randInt(0, list.length - 1);
    return list[idx];
  }

  function generateProblem() {
    const shapeType = chooseShapeType();
    const skill = chooseSkill();
    const params = {};
    let correct, prompt, steps, description, shapeLabel;

    function makeAreaUnit(val) {
      return formatNumber(val) + " cm²";
    }
    function makePerimeterUnit(val) {
      return formatNumber(val) + " cm";
    }

    if (shapeType === "square") {
      const side = randLength();
      params.side = side;
      shapeLabel = "square";
      if (skill === "area") {
        const area = side * side;
        correct = area;
        prompt = "Calculate the area of the square.";
        steps = "Formula: A = side × side\nA = " + side + " × " + side + " = " + makeAreaUnit(area);
      } else {
        const per = 4 * side;
        correct = per;
        prompt = "Calculate the perimeter of the square.";
        steps = "Formula: P = 4 × side\nP = 4 × " + side + " = " + makePerimeterUnit(per);
      }
      description = "Square with side " + side + " cm.";
    } else if (shapeType === "rectangle") {
      let w = randLength();
      let h = randLength();
      params.width = w;
      params.height = h;
      shapeLabel = "rectangle";
      if (skill === "area") {
        const area = w * h;
        correct = area;
        prompt = "Calculate the area of the rectangle.";
        steps = "Formula: A = length × width\nA = " + w + " × " + h + " = " + makeAreaUnit(area);
      } else {
        const per = 2 * (w + h);
        correct = per;
        prompt = "Calculate the perimeter of the rectangle.";
        steps = "Formula: P = 2 × (length + width)\nP = 2 × (" + w + " + " + h + ") = " + makePerimeterUnit(per);
      }
      description = "Rectangle with sides " + w + " cm and " + h + " cm.";
    } else if (shapeType === "parallelogram") {
      const base = randLength();
      const side = randLength();
      const heightVal = randLength();
      params.base = base;
      params.side = side;
      params.height = heightVal;
      shapeLabel = "parallelogram";
      if (skill === "area") {
        const area = base * heightVal;
        correct = area;
        prompt = "Calculate the area of the parallelogram.";
        steps = "Formula: A = base × height\nA = " + base + " × " + heightVal + " = " + makeAreaUnit(area);
      } else {
        const per = 2 * (base + side);
        correct = per;
        prompt = "Calculate the perimeter of the parallelogram.";
        steps = "Formula: P = 2 × (base + side)\nP = 2 × (" + base + " + " + side + ") = " + makePerimeterUnit(per);
      }
      description = "Parallelogram with base " + base + " cm, side " + side + " cm and height " + heightVal + " cm.";
    } else if (shapeType === "rhombus") {
      const side = randLength();
      const heightVal = randLength();
      params.side = side;
      params.height = heightVal;
      shapeLabel = "rhombus";
      if (skill === "area") {
        const area = side * heightVal;
        correct = area;
        prompt = "Calculate the area of the rhombus.";
        steps = "Formula: A = base × height\nA = " + side + " × " + heightVal + " = " + makeAreaUnit(area);
      } else {
        const per = 4 * side;
        correct = per;
        prompt = "Calculate the perimeter of the rhombus.";
        steps = "Formula: P = 4 × side\nP = 4 × " + side + " = " + makePerimeterUnit(per);
      }
      description = "Rhombus with side " + side + " cm and height " + heightVal + " cm.";
    } else if (shapeType === "rightTriangle") {
      const leg1 = randLength();
      const leg2 = randLength();
      const hyp = randLength();
      params.leg1 = leg1;
      params.leg2 = leg2;
      params.hyp = hyp;
      shapeLabel = "right-angled triangle";
      if (skill === "area") {
        const area = leg1 * leg2 / 2;
        correct = area;
        prompt = "Calculate the area of the right-angled triangle.";
        steps = "Formula: A = base × height ÷ 2\nHere base and height are the two legs.\nA = " +
          leg1 + " × " + leg2 + " ÷ 2 = " + makeAreaUnit(area);
      } else {
        const per = leg1 + leg2 + hyp;
        correct = per;
        prompt = "Calculate the perimeter of the right-angled triangle.";
        steps = "Formula: P = a + b + c\nP = " + leg1 + " + " + leg2 + " + " +
          hyp + " = " + makePerimeterUnit(per);
      }
      description = "Right-angled triangle with legs " + leg1 + " cm, " + leg2 + " cm and third side " + hyp + " cm.";
    } else if (shapeType === "isoscelesTriangle") {
      const equal = randLength();
      const base = randLength();
      const heightVal = randLength();
      params.equal = equal;
      params.base = base;
      params.height = heightVal;
      shapeLabel = "isosceles triangle";
      if (skill === "area") {
        const area = base * heightVal / 2;
        correct = area;
        prompt = "Calculate the area of the isosceles triangle.";
        steps = "Formula: A = base × height ÷ 2\nA = " + base + " × " + heightVal +
          " ÷ 2 = " + makeAreaUnit(area);
      } else {
        const per = 2 * equal + base;
        correct = per;
        prompt = "Calculate the perimeter of the isosceles triangle.";
        steps = "Formula: P = a + a + b\nP = " + equal + " + " + equal + " + " +
          base + " = " + makePerimeterUnit(per);
      }
      description = "Isosceles triangle with equal sides " + equal + " cm, base " +
        base + " cm and height " + heightVal + " cm.";
    } else if (shapeType === "equilateralTriangle") {
      const side = randLength();
      const heightVal = randLength();
      params.side = side;
      params.height = heightVal;
      shapeLabel = "equilateral triangle";
      if (skill === "area") {
        const area = side * heightVal / 2;
        correct = area;
        prompt = "Calculate the area of the equilateral triangle.";
        steps = "Formula: A = base × height ÷ 2\nA = " + side + " × " + heightVal +
          " ÷ 2 = " + makeAreaUnit(area);
      } else {
        const per = 3 * side;
        correct = per;
        prompt = "Calculate the perimeter of the equilateral triangle.";
        steps = "Formula: P = 3 × side\nP = 3 × " + side + " = " + makePerimeterUnit(per);
      }
      description = "Equilateral triangle with side " + side + " cm and height " + heightVal + " cm.";
    } else if (shapeType === "scaleneTriangle") {
      const base = randLength();
      const side1 = randLength();
      const side2 = randLength();
      const heightVal = randLength();
      const obtuse = Math.random() < 0.4; // some scalene triangles are obtuse with external height
      params.base = base;
      params.side1 = side1;
      params.side2 = side2;
      params.height = heightVal;
      params.obtuse = obtuse;
      shapeLabel = "triangle";
      if (skill === "area") {
        const area = base * heightVal / 2;
        correct = area;
        prompt = "Calculate the area of the triangle.";
        steps = "Formula: A = base × height ÷ 2\nA = " + base + " × " + heightVal +
          " ÷ 2 = " + makeAreaUnit(area);
      } else {
        const per = base + side1 + side2;
        correct = per;
        prompt = "Calculate the perimeter of the triangle.";
        steps = "Formula: P = a + b + c\nP = " + base + " + " + side1 + " + " +
          side2 + " = " + makePerimeterUnit(per);
      }
      description = (obtuse ? "Obtuse " : "Scalene ") + "triangle with sides " + base + " cm, " +
        side1 + " cm, " + side2 + " cm and height " + heightVal + " cm.";
    }

    return {
      shapeType,
      shapeLabel,
      skill,
      params,
      correctAnswer: roundTo(correct, 2),
      prompt,
      steps,
      description
    };
  }

  // ---------- SVG drawing ----------
  function buildSVG(problem, small) {
    const p = problem.params;
    const labelSize = small ? 9 : 11;
    const width = 320;
    const height = 220;
    const stroke = "#000";
    const fill = problem.skill === "area" ? "#c5e1a5" : "#b3e5fc";

    function txt(x, y, text) {
      return '<text x="'+x+'" y="'+y+'" font-size="'+labelSize+'" fill="#000">'+text+'</text>';
    }
    function cm(val) {
      return formatNumber(val) + " cm";
    }

    let polygon = "";
    let labels = "";
    let extras = "";

    switch (problem.shapeType) {
      case "square":
        polygon = '<rect x="70" y="40" width="160" height="160" rx="4" ry="4" ' +
          'fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
        labels += txt(140, 32, cm(p.side));
        labels += txt(140, 220, cm(p.side));
        labels += txt(50, 130, cm(p.side));
        labels += txt(240, 130, cm(p.side));
        break;

      case "rectangle":
        polygon = '<rect x="50" y="60" width="200" height="120" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
        labels += txt(150, 52, cm(p.width));
        labels += txt(150, 210, cm(p.width));
        labels += txt(30, 130, cm(p.height));
        labels += txt(260, 130, cm(p.height));
        break;

      case "parallelogram":
        // Base horizontal, top parallel, height vertical
        polygon = '<polygon points="70,180 250,180 290,80 110,80" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
        labels += txt(160, 200, cm(p.base));
        labels += txt(50, 135, cm(p.side));
        extras += '<line x1="110" y1="80" x2="110" y2="180" stroke="'+stroke+'" stroke-dasharray="4,3" stroke-width="1.5"/>';
        extras += '<rect x="110" y="170" width="10" height="10" fill="none" stroke="'+stroke+'" stroke-width="1"/>';
        labels += txt(122, 140, cm(p.height));
        break;

      case "rhombus":
        // Rhombus styled like a parallelogram but narrower
        polygon = '<polygon points="110,190 230,190 260,100 140,100" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
        // side label along left slanted side
        labels += txt(90, 150, cm(p.side));
        // vertical height line from top edge to base
        extras += '<line x1="140" y1="100" x2="140" y2="190" stroke="'+stroke+'" stroke-dasharray="4,3" stroke-width="1.5"/>';
        extras += '<rect x="140" y="180" width="10" height="10" fill="none" stroke="'+stroke+'" stroke-width="1"/>';
        // height label just to the right of the dashed line
        labels += txt(154, 145, cm(p.height));
        break;

      case "rightTriangle":
        polygon = '<polygon points="70,200 260,200 70,60" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
        labels += txt(165, 215, cm(p.leg1));
        labels += txt(48, 135, cm(p.leg2));
        labels += txt(185, 120, cm(p.hyp));
        extras += '<rect x="70" y="190" width="10" height="10" fill="none" stroke="'+stroke+'" stroke-width="1"/>';
        break;

      case "isoscelesTriangle":
        polygon = '<polygon points="160,50 70,200 250,200" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
        labels += txt(52, 135, cm(p.equal));
        labels += txt(240, 135, cm(p.equal));
        labels += txt(150, 215, cm(p.base));
        extras += '<line x1="160" y1="50" x2="160" y2="200" stroke="'+stroke+'" stroke-dasharray="4,3" stroke-width="1.5"/>';
        extras += '<rect x="160" y="190" width="10" height="10" fill="none" stroke="'+stroke+'" stroke-width="1"/>';
        labels += txt(172, 135, cm(p.height));
        break;

      case "equilateralTriangle":
        polygon = '<polygon points="160,40 60,200 260,200" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
        labels += txt(110, 215, cm(p.side));
        labels += txt(46, 135, cm(p.side));
        labels += txt(238, 135, cm(p.side));
        extras += '<line x1="160" y1="40" x2="160" y2="200" stroke="'+stroke+'" stroke-dasharray="4,3" stroke-width="1.5"/>';
        extras += '<rect x="160" y="190" width="10" height="10" fill="none" stroke="'+stroke+'" stroke-width="1"/>';
        labels += txt(172, 135, cm(p.height));
        break;

      case "scaleneTriangle":
        if (p.obtuse) {
          // Obtuse scalene: apex left, height outside triangle
          polygon = '<polygon points="80,200 260,200 40,80" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
          labels += txt(160, 215, cm(p.base));
          labels += txt(90, 150, cm(p.side1));
          labels += txt(250, 150, cm(p.side2));
          extras += '<line x1="40" y1="80" x2="40" y2="200" stroke="'+stroke+'" stroke-dasharray="4,3" stroke-width="1.5"/>';
          extras += '<rect x="40" y="190" width="10" height="10" fill="none" stroke="'+stroke+'" stroke-width="1"/>';
          labels += txt(10, 140, cm(p.height));
        } else {
          // Acute scalene: height inside triangle, vertical
          polygon = '<polygon points="60,200 260,200 190,60" fill="'+fill+'" stroke="'+stroke+'" stroke-width="2"/>';
          labels += txt(150, 215, cm(p.base));
          labels += txt(48, 145, cm(p.side1));
          labels += txt(248, 145, cm(p.side2));
          extras += '<line x1="190" y1="60" x2="190" y2="200" stroke="'+stroke+'" stroke-dasharray="4,3" stroke-width="1.5"/>';
          extras += '<rect x="190" y="190" width="10" height="10" fill="none" stroke="'+stroke+'" stroke-width="1"/>';
          labels += txt(202, 145, cm(p.height));
        }
        break;
    }

    const svg = '<svg viewBox="0 0 '+width+' '+height+'" role="img" aria-label="Polygon diagram">'+
      '<rect x="0" y="0" width="'+width+'" height="'+height+'" fill="#fafafa" stroke="none"/>'+ 
      polygon + extras + labels +
      '</svg>';
    return svg;
  }

  // ---------- Game state ----------
  const state = {
    currentProblem: null,
    answered: false,
    lastCorrect: false,
    score: 0,
    streak: 0,
    bestStreak: 0,
    attempts: 0,
    correct: 0,
    incorrectList: [],
    timerId: null,
    timeLeft: 0
  };

  // ---------- DOM references ----------
  const diagramContainer = document.getElementById("diagramContainer");
  const promptTextEl = document.getElementById("promptText");
  const answerInput = document.getElementById("answerInput");
  const submitBtn = document.getElementById("submitBtn");
  const nextBtn = document.getElementById("nextBtn");
  const feedbackText = document.getElementById("feedbackText");
  const showStepsBtn = document.getElementById("showStepsBtn");
  const stepsText = document.getElementById("stepsText");
  const scoreValue = document.getElementById("scoreValue");
  const streakValue = document.getElementById("streakValue");
  const bestStreakValue = document.getElementById("bestStreakValue");
  const attemptsValue = document.getElementById("attemptsValue");
  const correctValue = document.getElementById("correctValue");
  const accuracyValue = document.getElementById("accuracyValue");
  const timerToggle = document.getElementById("timerToggle");
  const timerDuration = document.getElementById("timerDuration");
  const timerDisplay = document.getElementById("timerDisplay");
  const summaryPanel = document.getElementById("summaryPanel");
  const summaryBtn = document.getElementById("summaryBtn");
  const summaryText = document.getElementById("summaryText");
  const incorrectListEl = document.getElementById("incorrectList");
  const contrastToggle = document.getElementById("contrastToggle");

  const gameTab = document.getElementById("gameTab");
  const worksheetTab = document.getElementById("worksheetTab");
  const gameMode = document.getElementById("gameMode");
  const worksheetMode = document.getElementById("worksheetMode");
  const wsGenerateButtons = document.querySelectorAll(".ws-generate-btn");
  const wsRevealBtn = document.getElementById("wsRevealBtn");
  const wsHideBtn = document.getElementById("wsHideBtn");
  const worksheetContainer = document.getElementById("worksheetContainer");
  const devPanel = document.getElementById("devPanel");

  // ---------- Timer ----------
  function clearTimer() {
    if (state.timerId) {
      clearInterval(state.timerId);
      state.timerId = null;
    }
    timerDisplay.textContent = "";
  }

  function startTimer() {
    clearTimer();
    if (!timerToggle.checked) return;
    const secs = parseInt(timerDuration.value, 10) || 60;
    state.timeLeft = secs;
    timerDisplay.textContent = "Time: " + state.timeLeft + " s";
    state.timerId = setInterval(() => {
      state.timeLeft -= 1;
      if (state.timeLeft <= 0) {
        timerDisplay.textContent = "Time: 0 s";
        clearTimer();
        if (!state.answered) {
          handleTimeout();
        }
      } else {
        timerDisplay.textContent = "Time: " + state.timeLeft + " s";
      }
    }, 1000);
  }

  function handleTimeout() {
    state.answered = true;
    state.lastCorrect = false;
    state.attempts += 1;
    const correctVal = state.currentProblem.correctAnswer;
    const formatted = formatNumber(correctVal);
    feedbackText.textContent = "Time's up. The correct answer is " + formatted + ".";
    feedbackText.className = "error";
    stepsText.textContent = "";
    showStepsBtn.style.display = "inline";
    beep("wrong");
    state.incorrectList.push({
      description: state.currentProblem.description,
      skill: state.currentProblem.skill,
      correctAnswer: formatted,
      userAnswer: "(no answer – timed out)"
    });
    updateScore(false);
    enableNext();
  }

  // ---------- Game flow ----------
  function loadNewProblem() {
    const prob = generateProblem();
    state.currentProblem = prob;
    state.answered = false;
    state.lastCorrect = false;
    promptTextEl.textContent = prob.prompt;
    diagramContainer.innerHTML = buildSVG(prob, false);
    feedbackText.textContent = "";
    feedbackText.className = "";
    stepsText.textContent = "";
    showStepsBtn.style.display = "none";
    answerInput.value = "";
    answerInput.disabled = false;
    answerInput.focus();
    disableNext();
    clearTimer();
    startTimer();
  }

  function disableNext() {
    nextBtn.disabled = true;
    nextBtn.classList.remove("enabled");
  }

  function enableNext() {
    nextBtn.disabled = false;
    nextBtn.classList.add("enabled");
  }

  function updateScore(correct) {
    if (correct) {
      state.score += 10;
      state.streak += 1;
      state.bestStreak = Math.max(state.bestStreak, state.streak);
      state.correct += 1;
    } else {
      state.streak = 0;
    }
    const acc = state.attempts > 0 ? Math.round((state.correct / state.attempts) * 100) : 0;
    scoreValue.textContent = state.score;
    streakValue.textContent = state.streak;
    bestStreakValue.textContent = state.bestStreak;
    attemptsValue.textContent = state.attempts;
    correctValue.textContent = state.correct;
    accuracyValue.textContent = acc + "%";
  }

  function handleSubmit() {
    if (state.answered) return;
    const val = toNumber(answerInput.value);
    if (val === null) {
      feedbackText.textContent = "Please enter a number.";
      feedbackText.className = "error";
      return;
    }
    state.answered = true;
    clearTimer();
    const correctVal = state.currentProblem.correctAnswer;
    const formattedCorrect = formatNumber(correctVal);
    state.attempts += 1;

    if (approxEqual(val, correctVal, 0.05)) {
      state.lastCorrect = true;
      feedbackText.textContent = "Correct!";
      feedbackText.className = "success";
      stepsText.textContent = "";
      showStepsBtn.style.display = "none";
      beep("correct");
      updateScore(true);
    } else {
      state.lastCorrect = false;
      feedbackText.textContent = "Incorrect. The correct answer is " + formattedCorrect + ".";
      feedbackText.className = "error";
      stepsText.textContent = "";
      showStepsBtn.style.display = "inline";
      beep("wrong");
      state.incorrectList.push({
        description: state.currentProblem.description,
        skill: state.currentProblem.skill,
        correctAnswer: formattedCorrect,
        userAnswer: formatNumber(roundTo(val, 2))
      });
      updateScore(false);
    }
    enableNext();
  }

  function showSteps() {
    if (!state.currentProblem) return;
    stepsText.textContent = state.currentProblem.steps;
  }

  function showSummary() {
    summaryPanel.style.display = "block";
    const acc = state.attempts > 0 ? Math.round((state.correct / state.attempts) * 100) : 0;
    summaryText.textContent =
      "Questions attempted: " + state.attempts +
      " | Correct: " + state.correct +
      " | Accuracy: " + acc + "% | Score: " + state.score +
      " | Best streak: " + state.bestStreak;

    if (state.incorrectList.length === 0) {
      incorrectListEl.innerHTML = "<p>No incorrect questions so far.</p>";
    } else {
      const parts = [];
      state.incorrectList.forEach((item, i) => {
        const html = '<div class="incorrect-item">'+
          "<strong>" + (i+1) + ".</strong> " + item.description + "<br>" +
          "Skill: " + item.skill + "<br>" +
          "Your answer: " + item.userAnswer + "<br>" +
          "Correct answer: " + item.correctAnswer +
          "</div>";
        parts.push(html);
      });
      incorrectListEl.innerHTML = parts.join("");
    }
  }

  // ---------- Worksheet mode ----------
  function buildWorksheetQuestion(idx, problem) {
    const svg = buildSVG(problem, true).replace('<svg ', '<svg class="worksheet-diagram" ');
    const skillWord = problem.skill === "area" ? "area" : "perimeter";
    const qText = "Calculate the " + skillWord + " of the " + problem.shapeLabel + ".";
    const correctVal = problem.correctAnswer;
    const unit = problem.skill === "area" ? "cm²" : "cm";
    const answerText = formatNumber(correctVal) + " " + unit;

    return (
      '<div class="worksheet-question">' +
        '<div><strong>' + idx + '.</strong> ' + qText + '</div>' +
        svg +
        '<div class="worksheet-line"></div>' +
        '<div class="worksheet-answer">Answer: ' + answerText + '</div>' +
      '</div>'
    );
  }

  function generateWorksheet(count) {
    const parts = [];
    for (let i = 1; i <= count; i++) {
      const prob = generateProblem();
      parts.push(buildWorksheetQuestion(i, prob));
    }
    worksheetContainer.innerHTML = parts.join("");
  }

  function worksheetReveal(show) {
    const answers = worksheetContainer.querySelectorAll(".worksheet-answer");
    answers.forEach(a => {
      a.style.display = show ? "block" : "none";
    });
  }

  // ---------- Dev tests ----------
  function runDevTests() {
    const results = [];
    function test(desc, fn) {
      try {
        const ok = fn();
        results.push((ok ? "✔ " : "✖ ") + desc);
      } catch (e) {
        results.push("✖ " + desc + " (error: " + e.message + ")");
      }
    }

    test("Rectangle 5 × 3 → area 15", () => 5 * 3 === 15);
    test("Rectangle 5 × 3 → perimeter 16", () => 2 * (5 + 3) === 16);
    test("Square side 4 → area 16", () => 4 * 4 === 16);
    test("Square side 4 → perimeter 16", () => 4 * 4 === 16);
    test("Parallelogram base 14, height 8 → area 112", () => 14 * 8 === 112);
    test("Right triangle legs 3 and 4 → area 6", () => 3 * 4 / 2 === 6);
    test("Equilateral triangle side 6 → perimeter 18", () => 3 * 6 === 18);
    test("Rhombus side 5 → perimeter 20", () => 4 * 5 === 20);
    test("Decimal parsing '12,5' equals '12.5'", () => toNumber("12,5") === 12.5 && toNumber("12.5") === 12.5);
    test("Worksheet generator makes correct count", () => {
      generateWorksheet(5);
      const items = worksheetContainer.querySelectorAll(".worksheet-question");
      return items.length === 5;
    });

    devPanel.textContent = "Developer tests (read-only)\n" + results.join("\n");
  }

  // ---------- Event listeners ----------
  submitBtn.addEventListener("click", handleSubmit);
  nextBtn.addEventListener("click", () => loadNewProblem());

  answerInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      if (!state.answered) {
        handleSubmit();
      } else if (state.lastCorrect && !nextBtn.disabled) {
        loadNewProblem();
      }
    } else if (e.key === "Escape") {
      answerInput.value = "";
    }
  });

  showStepsBtn.addEventListener("click", showSteps);
  summaryBtn.addEventListener("click", showSummary);

  timerToggle.addEventListener("change", () => {
    clearTimer();
    if (!state.answered) startTimer();
  });

  timerDuration.addEventListener("change", () => {
    clearTimer();
    if (!state.answered) startTimer();
  });

  contrastToggle.addEventListener("change", () => {
    document.body.classList.toggle("high-contrast", contrastToggle.checked);
  });

  document.getElementById("shapeSetSelect").addEventListener("change", loadNewProblem);
  document.getElementById("skillSelect").addEventListener("change", loadNewProblem);

  gameTab.addEventListener("click", () => {
    gameTab.classList.add("active");
    worksheetTab.classList.remove("active");
    gameMode.style.display = "block";
    worksheetMode.style.display = "none";
  });

  worksheetTab.addEventListener("click", () => {
    gameTab.classList.remove("active");
    worksheetTab.classList.add("active");
    gameMode.style.display = "none";
    worksheetMode.style.display = "block";
  });

  wsGenerateButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const c = parseInt(btn.getAttribute("data-count"), 10);
      generateWorksheet(c);
      worksheetReveal(false);
    });
  });

  wsRevealBtn.addEventListener("click", () => worksheetReveal(true));
  wsHideBtn.addEventListener("click", () => worksheetReveal(false));

  // ---------- Init ----------
  function init() {
    if (window.location.search.indexOf("dev=1") !== -1) {
      devPanel.style.display = "block";
      runDevTests();
    }
    loadNewProblem();
  }

  init();
})();
</script>
</body>
</html>
